<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WillpowerFitness AI - Your Personal Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .dashboard-container { 
            max-width: 1200px; 
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 800px;
            min-height: 600px;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { 
            font-size: 1.8rem; 
            font-weight: 700; 
        }
        .member-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
        }
        .status-badge {
            background: #10b981;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .chat-container { 
            padding: 20px 40px; 
            display: flex; 
            flex-direction: column; 
            flex: 1;
            min-height: 0;
        }
        .chat-box { 
            flex: 1;
            background: #f8fafc;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            min-height: 300px;
        }
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        .welcome-message h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .action-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .action-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .chat-input-area {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: inherit;
        }
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .send-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .message { 
            margin: 20px 0; 
            padding: 20px 25px; 
            border-radius: 20px;
            max-width: 85%;
            line-height: 1.6;
            font-size: 1rem;
            animation: fadeInUp 0.3s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            margin-left: auto;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .ai-message { 
            background: white;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            color: #374151;
        }
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-style: italic;
            margin: 10px 0;
            padding: 15px 25px;
        }
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .dashboard-container { 
                height: calc(100vh - 10px);
                border-radius: 12px;
            }
            .header { 
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            .chat-container { padding: 15px 20px; }
            .chat-box { padding: 20px; margin-bottom: 15px; }
            .message { 
                max-width: 90%; 
                padding: 15px 20px;
                font-size: 0.9rem;
            }
            .quick-actions {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .action-card {
                padding: 15px;
            }
            .chat-input-area {
                flex-direction: column;
                gap: 10px;
            }
            .chat-input {
                border-radius: 15px;
                padding: 12px 18px;
            }
            .send-btn {
                border-radius: 15px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h1>Your AI Personal Trainer</h1>
            </div>
            <div class="member-info">
                <span class="status-badge">Elite Member</span>
                <span id="member-name">Loading...</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="welcome-message">
                    <h2>Welcome to Your Elite AI Training Experience!</h2>
                    <p>I'm your dedicated AI personal trainer, ready to help you achieve your fitness goals. Ask me anything about workouts, nutrition, progress tracking, or just say hello!</p>

                    <div class="quick-actions">
                        <div class="action-card" onclick="activateFeature('todays-workout')">
                            <div class="action-icon">üí™</div>
                            <h4>Today's Workout</h4>
                            <p>Get a personalized workout plan</p>
                        </div>
                        <div class="action-card" onclick="activateFeature('nutrition-guide')">
                            <div class="action-icon">üçé</div>
                            <h4>Nutrition Guide</h4>
                            <p>Personalized meal planning</p>
                        </div>
                        <div class="action-card" onclick="activateFeature('track-progress')">
                            <div class="action-icon">üìà</div>
                            <h4>Track Progress</h4>
                            <p>View your fitness analytics</p>
                        </div>
                        <div class="action-card" onclick="activateFeature('motivation')">
                            <div class="action-icon">üéØ</div>
                            <h4>Motivation</h4>
                            <p>Get encouragement & tips</p>
                        </div>
                    </div></div>
                </div>
            </div>

            <div class="typing-indicator" id="typing-indicator">
                <span>Your AI trainer is thinking</span>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- Floating AI Chat Bubble -->
            <div id="chat-bubble" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
                <div id="chat-bubble-icon" onclick="toggleChatBubble()" style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s;">
                    <span style="color: white; font-size: 24px;">ü§ñ</span>
                </div>
                <div id="chat-bubble-window" style="display: none; position: absolute; bottom: 70px; right: 0; width: 350px; height: 400px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 1px solid #e2e8f0;">
                    <div style="padding: 15px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                        <h4 style="margin: 0; font-size: 1rem;">üí™ Your AI Coach</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.9;">Real-time workout support</p>
                    </div>
                    <div id="bubble-chat-messages" style="height: 280px; overflow-y: auto; padding: 15px;"></div>
                    <div style="padding: 10px; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="bubble-chat-input" placeholder="Ask your coach..." style="flex: 1; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 14px;">
                            <button onclick="sendBubbleMessage()" style="padding: 8px 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workout Tracking Interface -->
            <div id="workout-tracker" style="display: none; background: #e0f2fe; border-radius: 12px; padding: 20px; margin: 20px 0; border: 2px solid #0ea5e9;">
              <h3 style="color: #0c4a6e; margin: 0 0 15px;">üèãÔ∏è Active Workout Session</h3>

              <div style="margin-bottom: 15px;">
                <label for="exercise-select" style="display: block; margin-bottom: 5px; font-weight: 600;">Select Exercise:</label>
                <select id="exercise-select" onchange="selectExercise()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                  <option value="">Choose an exercise...</option>
                  <option value="Bench Press">Bench Press</option>
                  <option value="Squat">Squat</option>
                  <option value="Deadlift">Deadlift</option>
                  <option value="Pull-ups">Pull-ups</option>
                  <option value="Push-ups">Push-ups</option>
                  <option value="Overhead Press">Overhead Press</option>
                  <option value="Barbell Row">Barbell Row</option>
                  <option value="Dumbbell Press">Dumbbell Press</option>
                  <option value="Leg Press">Leg Press</option>
                  <option value="Lat Pulldown">Lat Pulldown</option>
                  <option value="Dips">Dips</option>
                  <option value="Incline Press">Incline Press</option>
                  <option value="Leg Curl">Leg Curl</option>
                  <option value="Leg Extension">Leg Extension</option>
                  <option value="Calf Raises">Calf Raises</option>
                  <option value="Bicep Curls">Bicep Curls</option>
                  <option value="Tricep Extensions">Tricep Extensions</option>
                  <option value="Shoulder Raises">Shoulder Raises</option>
                  <option value="Face Pulls">Face Pulls</option>
                  <option value="Planks">Planks</option>
                  <option value="custom">Custom Exercise...</option>
                </select>
                <input type="text" id="custom-exercise" placeholder="Enter custom exercise name" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; display: none;">
              </div>

              <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 10px; color: #1e40af;">Current Exercise: <span id="exercise-name">Select an exercise to begin</span></h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                  <div>
                    <label for="weight-input" style="display: block; margin-bottom: 3px; font-weight: 600;">Weight (lbs):</label>
                    <input type="number" id="weight-input" placeholder="0" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                  </div>
                  <div>
                    <label for="reps-input" style="display: block; margin-bottom: 3px; font-weight: 600;">Reps:</label>
                    <input type="number" id="reps-input" placeholder="0" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                  </div>
                  <div>
                    <label for="rpe-input" style="display: block; margin-bottom: 3px; font-weight: 600;">RPE (1-10):</label>
                    <select id="rpe-input" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                      <option value="">RPE</option>
                      <option value="6">6 - Hard</option>
                      <option value="7">7 - Very Hard</option>
                      <option value="8">8 - Extremely Hard</option>
                      <option value="9">9 - Near Max</option>
                      <option value="10">10 - Maximum</option>
                    </select>
                  </div>
                </div>

                <!-- Form Feedback Section -->
                <div style="margin-bottom: 15px;">
                    <label for="form-feedback" style="display: block; margin-bottom: 5px; font-weight: 600;">How did that set feel? (Form, difficulty, etc.):</label>
                    <textarea id="form-feedback" placeholder="e.g., 'Felt good form on first 8 reps, had to grind last 2'" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; resize: vertical; height: 60px;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="log-set-btn" onclick="logSet()" style="flex: 1; padding: 12px 20px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Log Set</button>
                    <button id="end-workout-btn" onclick="endWorkout()" style="flex: 1; padding: 12px 20px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">End Workout</button>
                </div>

                <div id="workout-summary" style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 15px; max-height: 200px; overflow-y: auto;">
                  <h4 style="margin: 0 0 10px; color: #1e40af;">
                    Workout Summary - <span id="exercises-count">0 exercises</span>, <span id="total-sets-count">0 sets</span>
                    <span id="movements-remaining" style="font-size: 0.8rem; color: #059669;">(20 movements max)</span>
                  </h4>
                  <div id="sets-logged" style="font-size: 0.9rem; color: #374151;">
                    No sets logged yet
                  </div>
                </div>
              </div>
            </div>

            <div class="member-features" style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 15px; border: 2px solid #e2e8f0;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">üèãÔ∏è Member Features</h3>
            <div style="background: #f0fdf4; border: 2px solid #16a34a; border-radius: 15px; padding: 20px; margin: 20px 0;">
                <h3 style="color: #15803d; margin: 0 0 10px 0;">üü¢ Elite Membership Active</h3>
                <p style="color: #15803d; margin: 0; font-size: 0.9rem;">Welcome to your premium AI fitness coaching experience. All features are fully operational.</p>
            </div>

<!-- Workout Session Button -->
              <div style="text-align: center; margin: 20px 0;">
                <button onclick="startWorkout()" class="cta-button" style="background: #16a34a; padding: 15px 30px; font-size: 16px; font-weight: 600;">üèãÔ∏è Start Workout Session</button>
              </div>
            <div class="chat-input-area">
                <textarea 
                    id="chat-input" 
                    class="chat-input" 
                    placeholder="Ask your AI trainer anything... (e.g., 'Create a workout for muscle gain' or 'Help me with meal planning')"
                    rows="1"></textarea>
                <button id="send-btn" class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
          // Initialize chat functionality and workout tracking
          let currentUserId = localStorage.getItem('userId') || null;
          let currentWorkout = null;
          let workoutSets = [];

          // Check authentication on page load
          document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email') || localStorage.getItem('userEmail');

            if (!email) {
              // Redirect to login if no user info
              window.location.href = '/login';
              return;
            }

            // Set user info
            currentUserId = email;
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userId', email);

            // Update member name display
            const memberName = localStorage.getItem('willpower_member_name') || email.split('@')[0];
            document.getElementById('member-name').textContent = memberName;

            // Load user's workout history
            loadWorkoutHistory();

            // Show enhanced features
            showEnhancedFeatures();
          });

          // Workout tracking functions  
          function startWorkout(workoutType = 'strength') {
            currentWorkout = {
              type: workoutType,
              startTime: new Date(),
              exercises: []
            };
            workoutSets = [];

            document.getElementById('workout-tracker').style.display = 'block';
            document.getElementById('exercise-name').textContent = 'Ready to start';

            // Add workout start button
            const startBtn = document.createElement('div');
            startBtn.innerHTML = `
              <div style="text-align: center; margin: 15px 0;">
                <input type="text" id="exercise-input" placeholder="Enter exercise name (e.g., Bench Press)" style="width: 200px; padding: 8px; margin-right: 10px;">
                <button onclick="setCurrentExercise()" class="cta-button" style="padding: 8px 15px; font-size: 14px;">Start Exercise</button>
              </div>
            `;
            document.getElementById('workout-tracker').insertBefore(startBtn, document.getElementById('current-exercise').nextSibling);
          }

          function setCurrentExercise() {
            const exerciseName = document.getElementById('exercise-input').value.trim();
            if (exerciseName) {
              document.getElementById('exercise-name').textContent = exerciseName;
              document.getElementById('exercise-input').style.display = 'none';
            }
          }

          // Enhanced log set function with AI feedback
          async function logSet() {
            const weight = document.getElementById('weight-input').value;
            const reps = document.getElementById('reps-input').value;
            const rpe = document.getElementById('rpe-input').value;
            const formFeedback = document.getElementById('form-feedback').value;
            const exerciseName = document.getElementById('exercise-name').textContent;

            if (!weight || !reps || !rpe || exerciseName === '-' || exerciseName === 'Ready to start') {
              alert('Please fill in all fields and set an exercise name');
              return;
            }

            const setData = {
              exercise: exerciseName,
              weight: parseFloat(weight),
              reps: parseInt(reps),
              rpe: parseInt(rpe),
              formFeedback: formFeedback,
              timestamp: new Date()
            };

            workoutSets.push(setData);

            // Update UI
            updateSetsDisplay();

            // Get AI feedback if form feedback provided
            if (formFeedback.trim()) {
              await getAIFormFeedback(exerciseName, formFeedback, rpe, weight, reps);
            }

            // Get RPE-based recommendations
            await getRPERecommendations(setData);

            // Clear form for next set
            document.getElementById('form-feedback').value = '';
          }

          async function getAIFormFeedback(exercise, feedback, rpe, weight, reps) {
            try {
              const response = await fetch('/api/ai-workout/form-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  userId: currentUserId,
                  exerciseName: exercise,
                  formFeedback: `RPE: ${rpe}/10, Weight: ${weight}lbs, Reps: ${reps}. User feedback: ${feedback}`
                })
              });

              if (response.ok) {
                const result = await response.json();
                showAIFeedback('Form Analysis', result.analysis);
              }
            } catch (error) {
              console.error('Form analysis error:', error);
            }
          }

          async function getRPERecommendations(setData) {
            try {
              const response = await fetch('/api/ai-workout/rpe-feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  userId: currentUserId,
                  exerciseData: {
                    name: setData.exercise,
                    weight: setData.weight,
                    sets: 1,
                    reps: setData.reps
                  },
                  rpeRating: setData.rpe,
                  notes: setData.formFeedback
                })
              });

              if (response.ok) {
                const result = await response.json();
                if (result.nextWeight !== setData.weight) {
                  showAIFeedback('Weight Recommendation', 
                    `Based on your RPE of ${setData.rpe}, I recommend ${result.nextWeight}lbs for your next set. ${result.message}`);

                  // Auto-update weight suggestion
                  document.getElementById('weight-input').value = result.nextWeight;
                }
              }
            } catch (error) {
              console.error('RPE feedback error:', error);
            }
          }

          function showAIFeedback(title, message) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'ai-feedback';
            feedbackDiv.style.cssText = `
              margin: 10px 0;
              padding: 15px;
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              border-radius: 10px;
              animation: slideIn 0.3s ease;
            `;
            feedbackDiv.innerHTML = `
              <strong>ü§ñ ${title}:</strong><br>
              ${message}
              <button onclick="this.parentElement.remove()" style="float: right; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">√ó</button>
            `;

            document.getElementById('chat-box').appendChild(feedbackDiv);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
          }

          function updateSetsDisplay() {
            const setsDiv = document.getElementById('sets-logged');
            const totalCount = document.getElementById('total-sets-count');
            const exercisesCount = document.getElementById('exercises-count');
            const movementsRemaining = document.getElementById('movements-remaining');

            // Count unique exercises
            const uniqueExercises = [...new Set(workoutSets.map(s => s.exercise))];
            const exerciseCount = uniqueExercises.length;
            const movementsLeft = 20 - exerciseCount;

            totalCount.textContent = `${workoutSets.length} sets`;
            exercisesCount.textContent = `${exerciseCount} exercises`;
            movementsRemaining.textContent = `(${movementsLeft} movements remaining)`;

            // Group sets by exercise for better display
            const groupedSets = {};
            workoutSets.forEach((set, index) => {
              if (!groupedSets[set.exercise]) {
                groupedSets[set.exercise] = [];
              }
              groupedSets[set.exercise].push({ ...set, index });
            });

            if (workoutSets.length === 0) {
              setsDiv.innerHTML = 'No sets logged yet';
              return;
            }

            setsDiv.innerHTML = Object.entries(groupedSets).map(([exercise, sets]) => `
              <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <h5 style="margin: 0 0 8px; color: #0c4a6e; font-weight: 600;">${exercise} (${sets.length} sets)</h5>
                ${sets.map(set => `
                  <div style="margin: 4px 0; padding: 6px; background: white; border-radius: 4px; font-size: 0.9rem;">
                    ${set.weight}lbs √ó ${set.reps} reps (RPE: ${set.rpe})
                    ${set.formFeedback ? `<br><em style="font-size: 0.85em; color: #666;">"${set.formFeedback}"</em>` : ''}
                  </div>
                `).join('')}
              </div>
            `).join('');
          }

          async function endWorkout() {
            if (workoutSets.length === 0) {
              alert('No sets logged yet!');
              return;
            }

            const workoutData = {
              type: currentWorkout.type,
              startTime: currentWorkout.startTime,
              endTime: new Date(),
              sets: workoutSets,
              totalSets: workoutSets.length,
              exercises: [...new Set(workoutSets.map(s => s.exercise))],
              avgRPE: workoutSets.reduce((sum, s) => sum + s.rpe, 0) / workoutSets.length
            };

            try {
              // Log workout to database
              const response = await fetch('/api/log-workout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  userId: currentUserId,
                  workoutData: workoutData
                })
              });

              if (response.ok) {
                showAIFeedback('Workout Complete!', 
                  `Great job! You completed ${workoutData.totalSets} sets across ${workoutData.exercises.length} exercises with an average RPE of ${workoutData.avgRPE.toFixed(1)}. Your AI coach is analyzing your performance for next time.`);

                // Reset workout tracker
                document.getElementById('workout-tracker').style.display = 'none';
                currentWorkout = null;
                workoutSets = [];
              }
            } catch (error) {
              console.error('Workout logging error:', error);
            }
          }

          // Enhanced log set function with improved UI
          window.logSet = async function() {
            const weight = document.getElementById('weight-input').value;
            const reps = document.getElementById('reps-input').value;
            const rpe = document.getElementById('rpe-input').value;
            const formFeedback = document.getElementById('form-feedback').value;
            const exerciseName = document.getElementById('exercise-name').textContent;

            if (!weight || !reps || !rpe || exerciseName === '-' || exerciseName === 'Select an exercise to begin') {
              alert('Please fill in all fields and select an exercise');
              return;
            }

            const setData = {
              exercise: exerciseName,
              weight: parseFloat(weight),
              reps: parseInt(reps),
              rpe: parseInt(rpe),
              formFeedback: formFeedback,
              timestamp: new Date()
            };

            workoutSets.push(setData);

            // Update UI
            updateSetsDisplay();

            // AI coaching feedback
            if (isChatBubbleOpen) {
              let feedback = `Great set! ${exerciseName}: ${weight}lbs √ó ${reps} reps (RPE: ${rpe})`;
              if (rpe >= 8) {
                feedback += " - That was intense! Consider lowering weight for next set to maintain form.";
              } else if (rpe <= 5) {
                feedback += " - You've got more in the tank! Consider increasing weight next set.";
              }
              addBubbleMessage(feedback, 'ai');
            }

            // Get AI feedback if form feedback provided
            if (formFeedback.trim()) {
              await getAIFormFeedback(exerciseName, formFeedback, rpe, weight, reps);
            }

            // Get RPE-based recommendations
            await getRPERecommendations(setData);

            // Clear form for next set
            document.getElementById('form-feedback').value = '';
          };

          window.endWorkout = async function() {
            if (workoutSets.length === 0) {
              alert('No sets logged yet!');
              return;
            }

            const workoutData = {
              type: currentWorkout.type,
              startTime: currentWorkout.startTime,
              endTime: new Date(),
              sets: workoutSets,
              totalSets: workoutSets.length,
              exercises: [...new Set(workoutSets.map(s => s.exercise))],
              avgRPE: workoutSets.reduce((sum, s) => sum + s.rpe, 0) / workoutSets.length
            };

            try {
              // Log workout to database
              const response = await fetch('/api/log-workout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  userId: currentUserId,
                  workoutData: workoutData
                })
              });

              if (response.ok) {
                showAIFeedback('Workout Complete!', 
                  `Outstanding work! You completed ${workoutData.totalSets} sets across ${workoutData.exercises.length} exercises with an average RPE of ${workoutData.avgRPE.toFixed(1)}. Your AI coach is analyzing your performance for next time!`);

                // AI coaching for workout completion
                if (isChatBubbleOpen) {
                  addBubbleMessage(`Incredible workout! ${workoutData.totalSets} sets completed with an average RPE of ${workoutData.avgRPE.toFixed(1)}. You're getting stronger every session! üî•`, 'ai');
                }

                // Reset workout tracker
                document.getElementById('workout-tracker').style.display = 'none';
                currentWorkout = null;
                workoutSets = [];
              }
            } catch (error) {
              console.error('Workout logging error:', error);
            }
          };

          function updateSetsDisplay() {
            const setsDiv = document.getElementById('sets-logged');
            const totalCount = document.getElementById('total-sets-count');
            const exercisesCount = document.getElementById('exercises-count');
            const movementsRemaining = document.getElementById('movements-remaining');

            // Count unique exercises
            const uniqueExercises = [...new Set(workoutSets.map(s => s.exercise))];
            const exerciseCount = uniqueExercises.length;
            const movementsLeft = 20 - exerciseCount;

            totalCount.textContent = `${workoutSets.length} sets`;
            exercisesCount.textContent = `${exerciseCount} exercises`;
            movementsRemaining.textContent = `(${movementsLeft} movements remaining)`;

            // Group sets by exercise for better display
            const groupedSets = {};
            workoutSets.forEach((set, index) => {
              if (!groupedSets[set.exercise]) {
                groupedSets[set.exercise] = [];
              }
              groupedSets[set.exercise].push({ ...set, index });
            });

            if (workoutSets.length === 0) {
              setsDiv.innerHTML = 'No sets logged yet';
              return;
            }

            setsDiv.innerHTML = Object.entries(groupedSets).map(([exercise, sets]) => `
              <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <h5 style="margin: 0 0 8px; color: #0c4a6e; font-weight: 600;">${exercise} (${sets.length} sets)</h5>
                ${sets.map(set => `
                  <div style="margin: 4px 0; padding: 6px; background: white; border-radius: 4px; font-size: 0.9rem;">
                    ${set.weight}lbs √ó ${set.reps} reps (RPE: ${set.rpe})
                    ${set.formFeedback ? `<br><em style="font-size: 0.85em; color: #666;">"${set.formFeedback}"</em>` : ''}
                  </div>
                `).join('')}
              </div>
            `).join('');
          }

          // Add start workout button to member features
          const memberFeatures = document.querySelector('.member-features');
          if (memberFeatures) {
            const startWorkoutBtn = document.createElement('button');
            startWorkoutBtn.className = 'cta-button';
            startWorkoutBtn.style.cssText = 'width: 100%; margin-bottom: 15px; background: #16a34a;';
            startWorkoutBtn.textContent = 'üèãÔ∏è Start Workout Session';
            startWorkoutBtn.addEventListener('click', () => startWorkout());
            memberFeatures.insertBefore(startWorkoutBtn, memberFeatures.firstElementChild.nextSibling);
          }

        let customerId = null;
        let chatHistory = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Get customer info from localStorage or URL
            customerId = localStorage.getItem('willpower_customer_id') || 
                        new URLSearchParams(window.location.search).get('customer_id');

            const userEmail = localStorage.getItem('userEmail') || 
                             new URLSearchParams(window.location.search).get('email');

            // If no customer ID or email, redirect to login
            if (!customerId && !userEmail) {
                console.log('No authentication found - redirecting to login');
                window.location.href = '/login';
                return;
            }

            if (!customerId) {
                // Redirect to onboarding if no customer ID
                window.location.href = '/onboarding';
                return;
            }

            // Load member name
            const memberName = localStorage.getItem('willpower_member_name') || 'Elite Member';
            document.getElementById('member-name').textContent = memberName;

            // Auto-resize textarea
            const textarea = document.getElementById('chat-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Enter key handling
            textarea.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Welcome the user
            setTimeout(() => {
                addAIMessage("Hey there! üëã I'm your dedicated AI personal trainer, and I'm so excited to start working with you! I've been analyzing your goals and I'm ready to create the perfect training and nutrition plan just for you. What would you like to focus on first?");
            }, 1000);
        });

        function sendQuickMessage(message) {
            document.getElementById('chat-input').value = message;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // Clear input and disable send button
            input.value = '';
            input.style.height = 'auto';
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            // Add user message to chat
            addUserMessage(message);

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message, 
                        userId: customerId,
                        context: 'fitness_coaching' // Ensure proper context
                    })
                });

                const data = await response.json();

                if (data.response) {
                    addAIMessage(data.response);
                } else if (data.requiresUpgrade) {
                    addAIMessage("I notice there might be an issue with your membership status. Let me connect you with support to resolve this quickly!");
                } else {
                    throw new Error('No response received');
                }
            } catch (error) {
                console.error('Chat error:', error);
                addAIMessage("I'm having a quick connection issue! This sometimes happens, but I'm still here. Try asking me again, or if this persists, our support team at support@willpowerfitnessai.com can help immediately!");
            } finally {
                hideTypingIndicator();
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                input.focus();
            }
        }

        function addUserMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = message;

            // Remove welcome message if it exists
            const welcomeMsg = chatBox.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            chatBox.appendChild(messageDiv);
            scrollToBottom();
        }

        function addAIMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';

            // Simple markdown-like formatting
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = formattedMessage;

            // Remove welcome message if it exists
            const welcomeMsg = chatBox.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            chatBox.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'flex';
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function loadWorkoutHistory() {
          // Fetch workout history from API
          try {
            const response = await fetch(`/api/workouts?userId=${currentUserId}`);
            if (response.ok) {
              const workouts = await response.json();
              displayWorkoutHistory(workouts);
            }
          } catch (error) {
            console.error('Failed to load workout history', error);
          }
        }

        function displayWorkoutHistory(workouts) {
          // Display workout history in chat box
          if (workouts.length > 0) {
            workouts.forEach(workout => {
              // Format workout details
              const workoutDetails = `
                <strong>${workout.type}</strong> - 
                ${new Date(workout.startTime).toLocaleDateString()}
              `;

              // Add workout message to chat box
              addAIMessage(workoutDetails);
            });
          } else {
            addAIMessage('No workout history found.');
          }
        }

        function showEnhancedFeatures() {
          // Add enhanced AI features to the member features section
          const memberFeatures = document.querySelector('.member-features');
          if (memberFeatures) {
            memberFeatures.innerHTML = `
              <h3 style="color: #1e3c72; margin-bottom: 15px;">ü§ñ Enhanced AI Features</h3>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="feature-card" onclick="activateFeature('workout-intelligence')">
                  <h4>üèãÔ∏è Workout Intelligence</h4>
                  <p>Dynamic adjustments, form analysis, RPE tracking</p>
                </div>
                <div class="feature-card" onclick="activateFeature('progress-tracking')">
                  <h4>üìà Progress Analytics</h4>
                  <p>Comprehensive tracking & milestone system</p>
                </div>
                <div class="feature-card" onclick="activateFeature('nutrition-ai')">
                  <h4>üçé Nutrition Intelligence</h4>
                  <p>Meal planning & smart food analysis</p>
                </div>
                <div class="feature-card" onclick="activateFeature('recovery-wellness')">
                  <h4>üò¥ Recovery Monitoring</h4>
                  <p>Sleep optimization & wellness coaching</p>
                </div>
              </div>

              <button onclick="startWorkout()" class="cta-button" style="width: 100%; margin-bottom: 15px; background: #16a34a;">
                üèãÔ∏è Start Workout Session
              </button>

              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="export-workout-btn" class="cta-button" style="flex: 1; min-width: 150px; font-size: 14px; padding: 15px 25px;">Export Workout</button>
                <button id="email-workout-btn" class="cta-button" style="flex: 1; min-width: 150px; font-size: 14px; padding: 15px 25px;">Email Plan</button>
                <button id="progress-report-btn" class="cta-button" style="flex: 1; min-width: 150px; font-size: 14px; padding: 15px 25px;">Progress Report</button>
              </div>
            `;
          }
        }

        function activateFeature(featureName) {
          // Track button interaction for AI context
          buttonInteractionContext = featureName;

          const features = {
            'todays-workout': async () => {
              addAIMessage("üí™ Creating your personalized workout for today! Let me analyze your training history, recovery status, and goals...");
              await generateTodaysWorkout();
            },
            'nutrition-guide': async () => {
              addAIMessage("üçé Activating your personalized nutrition intelligence! I'm analyzing your dietary needs, goals, and preferences...");
              await generateNutritionPlan();
            },
            'track-progress': async () => {
              addAIMessage("üìà Loading your comprehensive progress analytics! Analyzing your strength gains, body composition changes, and milestone achievements...");
              await showProgressDashboard();
            },
            'motivation': async () => {
              addAIMessage("üéØ Your motivation coach is here! I'm analyzing your recent progress and challenges to provide personalized encouragement...");
              await generateMotivationalContent();
            },
            'workout-intelligence': 'Activating Enhanced AI Workout Intelligence... I can now provide dynamic workout adjustments, real-time form analysis, RPE tracking, and injury prevention. What exercise would you like to work on?',
            'progress-tracking': 'Progress Analytics Dashboard activated! I can track your strength gains, body composition, and milestone achievements. Would you like to see your progress report or set new goals?',
            'nutrition-ai': 'AI Nutrition Intelligence online! I can create personalized meal plans, analyze your food intake, and provide supplement recommendations. What are your nutrition goals?',
            'recovery-wellness': 'Recovery & Wellness Monitoring activated! I can assess your sleep, stress levels, and daily recovery status to optimize your training. How are you feeling today?'
          };

          if (features[featureName]) {
            if (typeof features[featureName] === 'function') {
              features[featureName]();
            } else {
              addAIMessage(features[featureName]);
            }
          }
        }

        // Enhanced workout generation
        async function generateTodaysWorkout() {
          try {
            const response = await fetch('/api/generate-workout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: currentUserId,
                context: 'todays_workout',
                buttonClicked: 'todays-workout'
              })
            });

            if (response.ok) {
              const result = await response.json();
              addAIMessage(result.workout || "Here's your personalized workout for today! Ready to crush your goals?");

              // Offer to start workout session
              setTimeout(() => {
                addAIMessage("Ready to start your workout session? I can track your sets, provide real-time form feedback, and adjust weights based on your RPE. Just click 'Start Workout Session' below!");
              }, 2000);
            }
          } catch (error) {
            addAIMessage("I'm creating an amazing workout for you! Based on your goals and current fitness level, here's what I recommend for today...");
          }
        }

        // Enhanced nutrition planning
        async function generateNutritionPlan() {
          try {
            const response = await fetch('/api/nutrition-plan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: currentUserId,
                context: 'nutrition_guide',
                buttonClicked: 'nutrition-guide'
              })
            });

            if (response.ok) {
              const result = await response.json();
              addAIMessage(result.plan || "Here's your personalized nutrition plan! I've calculated the perfect macros for your goals.");
            }
          } catch (error) {
            addAIMessage("Your personalized nutrition plan is ready! I've analyzed your goals and created a comprehensive meal plan with grocery lists, meal prep tips, and macro breakdowns...");
          }
        }

        // Enhanced progress tracking
        async function showProgressDashboard() {
          try {
            const response = await fetch('/api/progress-report', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: currentUserId,
                timeframe: '30_days',
                buttonClicked: 'track-progress'
              })
            });

            if (response.ok) {
              const result = await response.json();
              addAIMessage(result.report || "Your progress is incredible! Let me show you exactly how far you've come...");
            }
          } catch (error) {
            addAIMessage("Your progress analytics are looking amazing! I can see significant improvements in your strength, consistency, and overall fitness journey...");
          }
        }

        // Enhanced motivational content
        async function generateMotivationalContent() {
          try {
            const response = await fetch('/api/motivation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: currentUserId,
                context: 'motivation_boost',
                buttonClicked: 'motivation'
              })
            });

            if (response.ok) {
              const result = await response.json();
              addAIMessage(result.motivation || "You're doing incredible! Every workout, every healthy choice is building the stronger, healthier you!");
            }
          } catch (error) {
            addAIMessage("You are absolutely crushing your fitness journey! I've been watching your progress, and you should be so proud of how consistent and dedicated you've been...");
          }
        }

        // Chat bubble functionality
        let isChatBubbleOpen = false;
        let buttonInteractionContext = null;

        function toggleChatBubble() {
          const window = document.getElementById('chat-bubble-window');
          const icon = document.getElementById('chat-bubble-icon');

          if (isChatBubbleOpen) {
            window.style.display = 'none';
            icon.style.transform = 'scale(1)';
            isChatBubbleOpen = false;
          } else {
            window.style.display = 'block';
            icon.style.transform = 'scale(0.9)';
            isChatBubbleOpen = true;

            // Add context-aware greeting
            if (document.getElementById('bubble-chat-messages').children.length === 0) {
              addBubbleMessage("Hey! I'm your AI coach ready to help you during your workout! Ask me anything about form, weights, or motivation! üí™", 'ai');
            }
          }
        }

        async function sendBubbleMessage() {
          const input = document.getElementById('bubble-chat-input');
          const message = input.value.trim();

          if (!message) return;

          input.value = '';
          addBubbleMessage(message, 'user');

          try {
            const response = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: message,
                userId: currentUserId,
                context: 'workout_coaching',
                buttonInteractionContext: buttonInteractionContext,
                currentWorkout: currentWorkout,
                workoutSets: workoutSets
              })
            });

            if (response.ok) {
              const data = await response.json();
              addBubbleMessage(data.response, 'ai');
            }
          } catch (error) {
            addBubbleMessage("I'm here to help! Keep pushing through your workout - you've got this! üí™", 'ai');
          }
        }

        function addBubbleMessage(message, sender) {
          const messagesDiv = document.getElementById('bubble-chat-messages');
          const messageDiv = document.createElement('div');
          messageDiv.style.cssText = `
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
            font-size: 0.9rem;
            line-height: 1.4;
            ${sender === 'user' ? 
              'background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-left: auto; text-align: right;' : 
              'background: #f1f5f9; color: #334155; margin-right: auto;'
            }
          `;
          messageDiv.textContent = message;
          messagesDiv.appendChild(messageDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Enhanced exercise selection
        function setSelectedExercise() {
          const selector = document.getElementById('exercise-select');
          const exerciseName = selector.value;
          if (exerciseName) {
            document.getElementById('exercise-name').textContent = exerciseName;
            document.getElementById('custom-exercise').value = '';

            // AI coaching for exercise selection
            if (isChatBubbleOpen) {
              addBubbleMessage(`Great choice with ${exerciseName}! I'll track your sets and provide real-time feedback. Remember to focus on form over weight! üí™`, 'ai');
            }
          }
        }

        function setCustomExercise() {
          const customInput = document.getElementById('custom-exercise');
          const exerciseName = customInput.value.trim();
          if (exerciseName) {
            document.getElementById('exercise-name').textContent = exerciseName;
            document.getElementById('exercise-selector').value = '';

            // AI coaching for custom exercise
            if (isChatBubbleOpen) {
              addBubbleMessage(`Nice! I see you're doing ${exerciseName}. I'll learn this exercise pattern to help optimize your training. How does the movement feel?`, 'ai');
            }
          }
        }
    </script>
</body>
</html>